<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register</title>
</head>
<body>

<div style="text-align: center;">
    <h3>JHS Mock Trading Registration</h3>
</div>
<form onsubmit="return verifyInfo();" method="post" action="/api/v1/users/create">
    <label for="username"><b>Username</b></label>
    <input type="text" placeholder="Enter Username" name="username" id="username"
           pattern="^(?=[a-zA-Z0-9._]{3,20}$)(?!.*[_.]{2})[^_.].*[^_.]$" required>

    <label for="firstName"><b>First Name</b></label>
    <input type="text" placeholder="Enter First Name" name="firstName" id="firstName" required>

    <label for="lastName"><b>Last Name</b></label>
    <input type="text" placeholder="Enter Last Name" name="lastName" id="lastName" required>

    <label for="email"><b>Email</b></label>
    <input type="text" placeholder="Enter Email" name="email" id="email" pattern="^\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}$"
           required>

    <label for="password"><b>Password</b></label>
    <input type="password" placeholder="Enter Password" name="password" id="password" pattern="^\w(\w|[!@#$%]){4,32}"
           required>

    <label for="passwordValidate"><b>Confirm Password</b></label>
    <input type="password" placeholder="Confirm Password" name="passwordValidate" id="passwordValidate"
           pattern="^\w(\w|[!@#$%]){4,32}" required>
    <p id="mismatchedPasswordLabel" style="display: none">Passwords do not match!</p>

    <button type="submit">Register</button>

</form>
</body>
<script>

    let isUsernameValid = false;

    function verifyInfo() {

        console.log("Verifying info...");

        if (!isUsernameValid) return false;

        console.log("Username is valid");

        let password = document.getElementById("password").value;
        let passwordValidate = document.getElementById("passwordValidate").value;
        if (password !== passwordValidate) {
            document.getElementById("mismatchedPasswordLabel").style.display = "block";
            return false;
        }

        console.log("Passwords match");

        let Http = new XMLHttpRequest();
        let url = '/api/v1/users/create?username=' + document.getElementById("username").value
            + '&firstName=' + document.getElementById("firstName").value + '&lastName='
            + document.getElementById("lastName").value + '&email='
            + document.getElementById("email").value + '&password='
            + document.getElementById("password").value;
        Http.open("POST", url);
        // Http.send();

        Http.onreadystatechange = (e) => {
            if (Http.readyState === 4) {
                if (Http.status === 200) {
                    window.location.href = "/login";
                } else {
                    console.log("Error: " + Http.responseText);
                }
            }
        }

        return true;
    }

    function getUsernameAvailability() {
        let Http = new XMLHttpRequest();
        let url = window.location.origin + "/api/v1/users/username-available?username=" + this.value;
        Http.open("GET", url);
        Http.send();

        Http.onreadystatechange = (e) => {
            if (Http.readyState === 4) {
                if (Http.status === 200) {
                    if (Http.responseText === "true") {
                        this.style.backgroundColor = "lightgreen";
                        isUsernameValid = true;
                        console.log("Username is available");
                    } else {
                        this.style.backgroundColor = "red";
                        isUsernameValid = false;
                        console.log("Username is not available");
                    }
                } else {
                    console.log("Error: " + Http.responseText);
                }
            }
        }
    }

    document.getElementById("username").addEventListener("input", getUsernameAvailability);

    document.getElementById("passwordValidate").addEventListener("change", function () {
        if (document.getElementById("password").value !== document.getElementById("passwordValidate").value) {
            document.getElementById("mismatchedPasswordLabel").style.display = "block";
            document.getElementById("password").style.backgroundColor = "red";
            document.getElementById("passwordValidate").style.backgroundColor = "red";
        } else {
            document.getElementById("mismatchedPasswordLabel").style.display = "none";
            document.getElementById("password").style.backgroundColor = "lightgreen";
            document.getElementById("passwordValidate").style.backgroundColor = "lightgreen";
        }
    });
</script>
</html>